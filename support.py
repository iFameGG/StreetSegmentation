import numpy as np
from PIL import Image

def restore_mask(output):
    mask = np.argmax(output, axis=-1)
    mask = np.expand_dims(mask, axis=-1)
    return mask

def mask_to_img(mask, class_dict):
    mask = np.asarray(mask)
    color_mapper = np.vectorize(lambda x: tuple(class_dict[x]['color']))
    rgb_mask = color_mapper(mask)
    final_mask = np.array(rgb_mask).squeeze().transpose((1, 2, 0)).astype('uint8')
    return Image.fromarray(final_mask)

class_dict = {
    0: {'color': [165, 42, 42], 'name': 'Bird', 'id': 0},
    1: {'color': [0, 192, 0], 'name': 'Ground Animal', 'id': 1},
    2: {'color': [196, 196, 196], 'name': 'Curb', 'id': 2},
    3: {'color': [190, 153, 153], 'name': 'Fence', 'id': 3},
    4: {'color': [180, 165, 180], 'name': 'Guard Rail', 'id': 4},
    5: {'color': [90, 120, 150], 'name': 'Barrier', 'id': 5},
    6: {'color': [102, 102, 156], 'name': 'Wall', 'id': 6},
    7: {'color': [128, 64, 255], 'name': 'Bike Lane', 'id': 7},
    8: {'color': [140, 140, 200], 'name': 'Crosswalk - Plain', 'id': 8},
    9: {'color': [170, 170, 170], 'name': 'Curb Cut', 'id': 9},
    10: {'color': [250, 170, 160], 'name': 'Parking', 'id': 10},
    11: {'color': [96, 96, 96], 'name': 'Pedestrian Area', 'id': 11},
    12: {'color': [230, 150, 140], 'name': 'Rail Track', 'id': 12},
    13: {'color': [128, 64, 128], 'name': 'Road', 'id': 13},
    14: {'color': [110, 110, 110], 'name': 'Service Lane', 'id': 14},
    15: {'color': [244, 35, 232], 'name': 'Sidewalk', 'id': 15},
    16: {'color': [150, 100, 100], 'name': 'Bridge', 'id': 16},
    17: {'color': [70, 70, 70], 'name': 'Building', 'id': 17},
    18: {'color': [150, 120, 90], 'name': 'Tunnel', 'id': 18},
    19: {'color': [220, 20, 60], 'name': 'Person', 'id': 19},
    20: {'color': [255, 0, 0], 'name': 'Bicyclist', 'id': 20},
    21: {'color': [255, 0, 100], 'name': 'Motorcyclist', 'id': 21},
    22: {'color': [255, 0, 200], 'name': 'Other Rider', 'id': 22},
    23: {'color': [200, 128, 128], 'name': 'Lane Marking - Crosswalk', 'id': 23},
    24: {'color': [255, 255, 255], 'name': 'Lane Marking - General', 'id': 24},
    25: {'color': [64, 170, 64], 'name': 'Mountain', 'id': 25},
    26: {'color': [230, 160, 50], 'name': 'Sand', 'id': 26},
    27: {'color': [70, 130, 180], 'name': 'Sky', 'id': 27},
    28: {'color': [190, 255, 255], 'name': 'Snow', 'id': 28},
    29: {'color': [152, 251, 152], 'name': 'Terrain', 'id': 29},
    30: {'color': [107, 142, 35], 'name': 'Vegetation', 'id': 30},
    31: {'color': [0, 170, 30], 'name': 'Water', 'id': 31},
    32: {'color': [255, 255, 128], 'name': 'Banner', 'id': 32},
    33: {'color': [250, 0, 30], 'name': 'Bench', 'id': 33},
    34: {'color': [100, 140, 180], 'name': 'Bike Rack', 'id': 34},
    35: {'color': [220, 220, 220], 'name': 'Billboard', 'id': 35},
    36: {'color': [220, 128, 128], 'name': 'Catch Basin', 'id': 36},
    37: {'color': [222, 40, 40], 'name': 'CCTV Camera', 'id': 37},
    38: {'color': [100, 170, 30], 'name': 'Fire Hydrant', 'id': 38},
    39: {'color': [40, 40, 40], 'name': 'Junction Box', 'id': 39},
    40: {'color': [33, 33, 33], 'name': 'Mailbox', 'id': 40},
    41: {'color': [100, 128, 160], 'name': 'Manhole', 'id': 41},
    42: {'color': [142, 0, 0], 'name': 'Phone Booth', 'id': 42},
    43: {'color': [70, 100, 150], 'name': 'Pothole', 'id': 43},
    44: {'color': [210, 170, 100], 'name': 'Street Light', 'id': 44},
    45: {'color': [153, 153, 153], 'name': 'Pole', 'id': 45},
    46: {'color': [128, 128, 128], 'name': 'Traffic Sign Frame', 'id': 46},
    47: {'color': [0, 0, 80], 'name': 'Utility Pole', 'id': 47},
    48: {'color': [250, 170, 30], 'name': 'Traffic Light', 'id': 48},
    49: {'color': [192, 192, 192], 'name': 'Traffic Sign (Back)', 'id': 49},
    50: {'color': [220, 220, 0], 'name': 'Traffic Sign (Front)', 'id': 50},
    51: {'color': [140, 140, 20], 'name': 'Trash Can', 'id': 51},
    52: {'color': [119, 11, 32], 'name': 'Bicycle', 'id': 52},
    53: {'color': [150, 0, 255], 'name': 'Boat', 'id': 53},
    54: {'color': [0, 60, 100], 'name': 'Bus', 'id': 54},
    55: {'color': [0, 0, 142], 'name': 'Car', 'id': 55},
    56: {'color': [0, 0, 90], 'name': 'Caravan', 'id': 56},
    57: {'color': [0, 0, 230], 'name': 'Motorcycle', 'id': 57},
    58: {'color': [0, 80, 100], 'name': 'On Rails', 'id': 58},
    59: {'color': [128, 64, 64], 'name': 'Other Vehicle', 'id': 59},
    60: {'color': [0, 0, 110], 'name': 'Trailer', 'id': 60},
    61: {'color': [0, 0, 70], 'name': 'Truck', 'id': 61},
    62: {'color': [0, 0, 192], 'name': 'Wheeled Slow', 'id': 62},
    63: {'color': [32, 32, 32], 'name': 'Car Mount', 'id': 63},
    64: {'color': [120, 10, 10], 'name': 'Ego Vehicle', 'id': 64},
    65: {'color': [0, 0, 0], 'name': 'Unlabeled', 'id': 65}
}

weights = [
    3.938674926757812e-06,
    1.721636454264323e-05,
    0.00787016995747884,
    0.013714621861775717,
    0.0028396275838216147,
    0.004570476531982422,
    0.008746203104654947,
    0.0033842474619547526,
    0.0022887738545735677,
    0.0008545824686686198,
    0.0020970923105875653,
    0.004418588638305664,
    0.0013369693756103516,
    0.18321743774414062,
    0.0017660115559895834,
    0.028756528854370116,
    0.00793446413675944,
    0.12437188466389974,
    0.0009324957529703777,
    0.0033283729553222658,
    0.0003765970865885417,
    0.0002310803731282552,
    1.6152064005533855e-05,
    0.007408554712931315,
    0.01325009028116862,
    0.0024722557067871093,
    8.556111653645833e-05,
    0.29156846809387205,
    0.003667917251586914,
    0.011258611679077149,
    0.15485126558939616,
    0.0004293212890625,
    0.0006215006510416666,
    0.00015761693318684897,
    6.82226816813151e-05,
    0.006434665044148763,
    0.000270575205485026,
    2.5269190470377604e-05,
    5.024909973144531e-05,
    0.00041175460815429685,
    3.7349700927734376e-05,
    0.0005619544982910156,
    8.326594034830729e-05,
    3.295453389485677e-05,
    0.0005977916717529297,
    0.008435787200927735,
    0.0009442640940348307,
    0.004213568369547526,
    0.0019060554504394531,
    0.0007961750030517578,
    0.004710861206054687,
    0.0006743087768554687,
    0.0006568794250488281,
    5.8919270833333336e-05,
    0.002604583740234375,
    0.034741377512613934,
    2.4789174397786457e-05,
    0.0006234353383382162,
    0.00035889307657877603,
    0.00033934847513834637,
    6.957499186197917e-05,
    0.003725550969441732,
    5.6302388509114586e-05,
    0.0010541585286458334,
    0.019545946756998698,
    0.01704047139485677
]